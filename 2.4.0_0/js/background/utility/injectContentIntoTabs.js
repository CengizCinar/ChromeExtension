"use strict";import{jsFiles}from"../constants/jsFiles.js";import{cssFiles}from"../constants/cssFiles.js";import{IS_BETA_EXTENSION}from"../constants/gulpBetaExtensionFlag.js";import{contentScriptMessages}from"../../content/constants/contentScriptMessages.js";import{backgroundScriptMessages}from"../../content/constants/backgroundScriptMessages.js";import{isAmazonProductPage,parseAmazonProductPageUrl}from"../../content/utility/parseAmz/amazonUrlParser.js";import{CONTENT_SCRIPT_STATUSES}from"../constants/contentScriptStatus.js";import{manageConflictsWithLegacyExtension}from"./handleBetaExtension.js";import{isSasAutoInjectableUrl}from"./sasUrlParser.js";const injectedTabs={},addTabIdToInjectedTabs=t=>{injectedTabs[t]||(injectedTabs[t]={})},autoInjectContentScriptIntoTab=async t=>{await handleScriptInjection(t),IS_BETA_EXTENSION&&manageConflictsWithLegacyExtension(t)},handleChangeInfoUpdate=async t=>{var e;!isSasAutoInjectableUrl(t.url)&&isAmazonProductPage(t.url)?(e=(await chrome.storage.sync.get())["options"],(injectedTabs[t.id]?.contentScriptStatus&&injectedTabs[t.id]?.contentScriptStatus!==CONTENT_SCRIPT_STATUSES.UNLOADED||e.isAutoAnalyzer)&&await handleVariationClick(t)):await autoInjectContentScriptIntoTab(t)},injectContentIntoTabs=()=>{chrome.tabs.onActivated.addListener(async({tabId:t})=>{t=await chrome.tabs.get(t);await autoInjectContentScriptIntoTab(t)}),chrome.tabs.onUpdated.addListener(async(t,e,n)=>{"loading"===e.status&&(e.url?await handleChangeInfoUpdate(n):await autoInjectContentScriptIntoTab(n))}),chrome.runtime.onMessage.addListener((t,e)=>{t?.message===contentScriptMessages.LOADING&&e.tab&&injectedTabs[e.tab.id]&&(injectedTabs[e.tab.id].contentScriptStatus=CONTENT_SCRIPT_STATUSES.LOADING)}),chrome.runtime.onMessage.addListener((t,e)=>{t?.message===contentScriptMessages.READY&&e.tab&&injectedTabs[e.tab.id]&&(injectedTabs[e.tab.id].contentScriptStatus=CONTENT_SCRIPT_STATUSES.READY)}),chrome.runtime.onMessage.addListener((t,e)=>{t?.message===contentScriptMessages.UNLOADED&&e.tab&&injectedTabs[e.tab.id]&&(injectedTabs[e.tab.id].contentScriptStatus=CONTENT_SCRIPT_STATUSES.UNLOADED)}),chrome.tabs.onRemoved.addListener(t=>{delete injectedTabs[t]}),chrome.runtime.onConnect.addListener(e=>{e.onMessage.addListener(({message:t})=>{t===contentScriptMessages.CHECK_STATUS&&e.postMessage({status:"active"})}),e.onDisconnect.addListener(()=>{var t=e.sender.tab?.id;injectedTabs[t]&&(injectedTabs[t].contentScriptStatus=CONTENT_SCRIPT_STATUSES.UNLOADED)})})},sendRequestToHandleVariationChange=async(t,e,n)=>{await chrome.tabs.sendMessage(t,{command:"dosas",source_url:n,selectionText:e,no_display_update:!0})},handleVariationClick=async n=>{const a=parseAmazonProductPageUrl(n.url),s=async(t,e)=>{if(t?.message===contentScriptMessages.READY&&e.tab?.id===n.id)try{await sendRequestToHandleVariationChange(n.id,a[5],n.url)}finally{chrome.runtime.onMessage.removeListener(s)}else t?.message===contentScriptMessages.UNLOADED&&e.tab?.id===n.id&&chrome.runtime.onMessage.removeListener(s)};chrome.runtime.onMessage.addListener(s);try{var t=await handleScriptInjection(n);t?.contentScriptStatus===CONTENT_SCRIPT_STATUSES.READY?(chrome.runtime.onMessage.removeListener(s),await sendRequestToHandleVariationChange(n.id,a[5],n.url)):t?.contentScriptStatus===CONTENT_SCRIPT_STATUSES.UNLOADED&&chrome.runtime.onMessage.removeListener(s)}catch(t){console.log(t)}},handleScriptInjection=async(e={})=>{e=e.id;addTabIdToInjectedTabs(e);try{if(await chrome.tabs.sendMessage(e,{command:backgroundScriptMessages.CHECK_INJECTION}),injectedTabs[e])return injectedTabs[e].contentScriptStatus=CONTENT_SCRIPT_STATUSES.READY,{contentScriptStatus:CONTENT_SCRIPT_STATUSES.READY}}catch(t){if(injectedTabs[e]?.contentScriptStatus!==CONTENT_SCRIPT_STATUSES.LOADING)try{await injectContent(e)}catch(t){injectedTabs[e]&&(injectedTabs[e].contentScriptStatus=CONTENT_SCRIPT_STATUSES.UNLOADED)}return injectedTabs[e]?{contentScriptStatus:injectedTabs[e].contentScriptStatus}:{contentScriptStatus:CONTENT_SCRIPT_STATUSES.UNLOADED}}},injectContent=async t=>{await Promise.all([chrome.scripting.executeScript({target:{tabId:t},files:jsFiles}),chrome.scripting.insertCSS({target:{tabId:t},files:cssFiles})])};export{injectContentIntoTabs,handleVariationClick,handleScriptInjection};